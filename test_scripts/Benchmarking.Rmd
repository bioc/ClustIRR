---
title: "Benchmarking"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{benchmarking}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(gliphR)
library(turboGliph)
```

This vignette compares the gliphR package with the turboGliph package.


# Create input data

```{r}

data("hs_CD8_ref")
ref <- base::grep(pattern = "^C.*F$",x = hs_CD8_ref$CDR3b,
                  perl = TRUE,value = TRUE)
ref <- data.frame(CDR3b = ref, TRBV = NA, TRBJ = NA)

data_sample <- ref[sample(x = 1:nrow(ref), size = 2000, replace = F), 1:3]
data_ref <- ref[, 1:3]

```


# Cluster with gliphR versions

```{r}

# prepare input parameters
ks <- c(2, 3, 4)
B <- 1000
cores <- 12 # later to be changed
control_input <- list(
    B = 1000,
    global_max_dist = 1,
    local_min_fdr = 0.05,
    local_min_ove = c(10^3, 10^2, 10^1),
    local_min_o = 3,
    trim_flanks = FALSE,
    flank_size = 3,
    low_mem = F,
    global_pairs = NULL)

# run the three versions of gliphR
out_v1 <- gliph(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2 <- gliph(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)


out_v3 <- gliph(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

# put in the same data for ref and sample
out_v1_b <- gliph(data_sample = data_sample,
                data_ref = data_sample,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2_b <- gliph(data_sample = data_sample,
                data_ref = data_sample,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)


out_v3_b <- gliph(data_sample = data_sample,
                data_ref = data_sample,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

```

# Cluster with turboGliph versions

```{r}

jan_v1 <- turboGliph::turbo_gliph(
    cdr3_sequences = data_sample,
    refdb_beta = data_ref,
    lcminp = 0.05,
    gccutoff = 1,
    structboundaries = F,
    boundary_size = 0,
    cluster_min_size = 1,
    accept_sequences_with_C_F_start_end = T)


# to be investigated, not working with input
# jan_v2 <- turboGliph::gliph2(
#     cdr3_sequences = data_sample,
#     refdb_beta = data_ref,
#     lcminp = 0.05,
#     cdr3_length_freq = NULL,
#     sim_depth = 1000,
#     motif_distance_cutoff = 0,
#     accept_sequences_with_C_F_start_end = T,
#     structboundaries = T,
#     min_seq_length = 1
#     )

# put in sample as ref for checking
jan_v1_b <- turboGliph::turbo_gliph(
    cdr3_sequences = data_sample,
    refdb_beta = data_sample,
    lcminp = 0.05,
    gccutoff = 1,
    structboundaries = F,
    boundary_size = 0,
    cluster_min_size = 1,
    accept_sequences_with_C_F_start_end = T)


```
# Compare results

```{r}

e_v1 <- out_v1$clust$CDR3b$motif_enrichment
e_v2 <- out_v2$clust$CDR3b$motif_enrichment
e_v3 <- out_v3$clust$CDR3b$motif_enrichment

e_v1_b <- out_v1$clust$CDR3b$motif_enrichment
e_v2_b <- out_v2$clust$CDR3b$motif_enrichment
e_v3_b <- out_v3$clust$CDR3b$motif_enrichment

e_jan_v1 <- jan_v1$motif_enrichment$selected_motifs
#e_jan_v2 <- jan_v2$motif_enrichment$selected_motifs

e_jan_v1_b <- jan_v1$motif_enrichment$selected_motifs

```
