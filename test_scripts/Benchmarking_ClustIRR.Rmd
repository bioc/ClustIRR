---
title: "Benchmarking"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{benchmarking}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
require(ClustIRR)
require(ggplot2)
require(patchwork)
require(immuneSIM)

```


# Create input data

```{r create_input_data}

# set seed for reproducibility
set.seed(1234)

# ## create artificial reference repertoire with immuneSIM package
# data_ref_full <- immuneSIM(
#   number_of_seqs = 10000,       # number of simulated sequences
#   species = "hs",               # species (human)
#   receptor = "tr",              # receptor-type (t-cells)
#   chain = "b",                  # chain type (beta chain)
#   max_cdr3_length = 100,        # max cdr3 length
#   min_cdr3_length = 6,          # min cdr3 length
#   user_defined_alpha = 1.1,     # clone count distribution
#   verbose = TRUE)               # output progress
# 
# save(data_ref_full, file="immuneSIM/immuneSIM_10000seqs.RData")

# load precomputed repertoire
load("immuneSIM/immuneSIM_10000seqs.RData")

## insert motifs

# # create n random motifs of length k
# motifs <- list(
#   "n" = 3,                      # 3 different motifs
#   "k" = 4,                      # 4mer's
#   "freq" = c(0.05, 0.25, 0.4))  # occurrence probabilities

# create motifs manually
motifs <- data.frame(aa   = c("YPGQ","VNTE"),
                    nt   = c("gccgcc","tttttt"),
                    freq = c(0.2,0.1))

data_sample_full <- motif_implantation(
  sim_repertoire = data_ref_full,  # source repertoire
  motif = motifs,                  # motifs to implant
  fixed_pos = 5)                   # insert at random (0) or fixed (n) position

# random subset motif enriched dataset to simulate realistic sampling
data_sample_full <- data.frame(data_sample_full[sample(1:nrow(data_sample_full),
                                             500,
                                             replace = FALSE),])

# Reduce to CDR3b sequence
data_ref    <- data.frame(data_ref_full[,4])
data_sample <- data.frame(data_sample_full[,4])
names(data_ref)[1]    <- "CDR3b"
names(data_sample)[1] <- "CDR3b"

## Insert global sequence for global check

# Random sequences for clonal expansion simulation
cl_expansion1 <- c(CDR3b = "QQQQTTTQQQQTTT")
cl_expansion2 <- c(CDR3b = "QQQQTTTQQQQTTQ")

# Insert 1 time in data_ref for reference (does not matter)
data_ref <- rbind(data_ref, cl_expansion1)
data_ref <- rbind(data_ref, cl_expansion2)

# Insert each 100 times in sample
data_sample_exp <- data_sample
for(i in 0:99) {
  data_sample_exp <- rbind(data_sample_exp, cl_expansion1)
  data_sample_exp <- rbind(data_sample_exp, cl_expansion2)
}


rm(i, cl_expansion1, cl_expansion2, data_sample_full, data_ref_full, motifs)

```


# OvE Ground truth

```{r, ove_ground_truth}
# Compute OvE for data
# (f_sample / n_sample) / (f_ref / n_ref)
# f_ref/sample = motifs of a certain length found in ref / sample
# n_ref/sample = motif count of a certain length present in ref / sample

# motif length
motif_length <- 4

# find motifs
f_ref        <- stringdist::qgrams(data_ref$CDR3b,        q=motif_length)
f_sample     <- stringdist::qgrams(data_sample$CDR3b,     q=motif_length)
f_sample_exp <- stringdist::qgrams(data_sample_exp$CDR3b, q=motif_length)

# convert to data frames
f_ref        <- f_ref[1,]
f_ref        <- data.frame(motif=names(f_ref), 
                           f_ref=as.numeric(f_ref))
f_sample     <- f_sample[1,]
f_sample     <- data.frame(motif=names(f_sample), 
                           f_sample=as.numeric(f_sample))
f_sample_exp <- f_sample_exp[1,]
f_sample_exp <- data.frame(motif=names(f_sample_exp), 
                           f_sample_exp=as.numeric(f_sample_exp))

# find motif counts
f_ref$n_ref               <- sum(f_ref$f_ref)
f_sample$n_sample         <- sum(f_sample$f_sample)
f_sample_exp$n_sample_exp <- sum(f_sample_exp$f_sample_exp)

# consolidate to motifs found in sample
f_ref     <- f_ref[f_ref$motif %in% f_sample$motif, ]
f_ref_exp <- f_ref[f_ref$motif %in% f_sample_exp$motif, ]
gt_motifs     <- merge(f_sample,     f_ref, by = "motif", all = TRUE)
gt_motifs_exp <- merge(f_sample_exp, f_ref, by = "motif", all = TRUE)

gt_motifs[is.na(gt_motifs[, "f_ref"]), "f_ref"] <- 0
gt_motifs[is.na(gt_motifs[, "n_ref"]), "n_ref"] <- gt_motifs$n_ref[1]
gt_motifs_exp[is.na(gt_motifs_exp[, "f_ref"]), "f_ref"] <- 0
gt_motifs_exp[is.na(gt_motifs_exp[, "n_ref"]), "n_ref"] <- 
  gt_motifs_exp$n_ref[1]

# compute ove
gt_motifs$ove <- (gt_motifs$f_sample / gt_motifs$n_sample) / 
  (gt_motifs$f_ref / gt_motifs$n_ref)
gt_motifs_exp$ove_exp <- (gt_motifs_exp$f_sample_exp / 
                            gt_motifs_exp$n_sample_exp) / 
  (gt_motifs_exp$f_ref / gt_motifs_exp$n_ref)


rm(f_ref, f_ref_exp, f_sample, f_sample_exp)


```



# Prepare input parameters

```{r create_parameters}
# v1 + v2 + v3
ks <- motif_length
cores <- parallel::detectCores()

control_input <- list(
  B = 1000,
  global_max_dist = 1,
  local_max_fdr = 0.05,
  local_min_ove = 2,
  local_min_o = 3,
  trim_flank_aa = 0,
  low_mem = FALSE,
  global_pairs = NULL)

```

# Cluster with ClustIRR versions

```{r run_clustirr}
# data_sample with inserted motifs but without clonal expansion
out_v1 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)


out_v3 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

# data_sample with inserted motifs and clonal expansion
out_v1_exp <- cluster_irr(data_sample = data_sample_exp,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2_exp <- cluster_irr(data_sample = data_sample_exp,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)


out_v3_exp <- cluster_irr(data_sample = data_sample_exp,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

rm(cores, ks, control_input)

```


# Compare results


```{r compare_results, fig.width=8, fig.height=8, fig.align='center'}
# one big table
all_versions <- merge(out_v1$clust$CDR3b$local$m, 
                      out_v2$clust$CDR3b$local$m,
                      by = "motif", all = TRUE)
all_versions <- merge(all_versions, 
                      out_v3$clust$CDR3b$local$m,
                      by = "motif", all = TRUE)

all_versions <- merge(all_versions, 
                      gt_motifs,
                      by = "motif", all = TRUE)

names(all_versions) <- c("motif", "v1_mean_f_ref", "v1_min_f_ref", 
                         "v1_max_f_ref", "v1_f_sample", "v1_ove", 
                         "v1_p", "v1_fdr", "v1_k", "v1_pass",
                         "v2_f_sample", "v2_n_sample", "v2_f_ref", 
                         "v2_n_ref", "v2_k", "v2_ove", "v2_ove_ci_l95", 
                         "v2_ove_ci_h95", "v2_p_value", "v2_fdr", "v2_pass",
                         "v3_f_sample", "v3_n_sample", "v3_f_ref", 
                         "v3_n_ref", "v3_k", "v3_ove", "v3_ove_ci_l95", 
                         "v3_ove_ci_h95", "v3_p_value", "v3_fdr", "v3_pass",
                         "gt_f_sample", "gt_n_sample","gt_f_ref", "gt_n_ref", 
                         "gt_ove")

# the same for expanded versions
# one big table
all_versions_exp <- merge(out_v1_exp$clust$CDR3b$local$m, 
                      out_v2_exp$clust$CDR3b$local$m,
                      by = "motif", all = TRUE)
all_versions_exp <- merge(all_versions_exp, 
                      out_v3_exp$clust$CDR3b$local$m,
                      by = "motif", all = TRUE)

all_versions_exp <- merge(all_versions_exp, 
                      gt_motifs_exp,
                      by = "motif", all = TRUE)

names(all_versions_exp) <- c("motif", "v1_mean_f_ref", "v1_min_f_ref", 
                         "v1_max_f_ref", "v1_f_sample", "v1_ove", 
                         "v1_p", "v1_fdr", "v1_k", "v1_pass",
                         "v2_f_sample", "v2_n_sample", "v2_f_ref", 
                         "v2_n_ref", "v2_k", "v2_ove", "v2_ove_ci_l95", 
                         "v2_ove_ci_h95", "v2_p_value", "v2_fdr", "v2_pass",
                         "v3_f_sample", "v3_n_sample", "v3_f_ref", 
                         "v3_n_ref", "v3_k", "v3_ove", "v3_ove_ci_l95", 
                         "v3_ove_ci_h95", "v3_p_value", "v3_fdr", "v3_pass",
                         "gt_f_sample_exp", "gt_n_sample_exp", 
                         "gt_f_ref", "gt_n_ref", "gt_ove_exp")

all_versions$delta_v2 <- (all_versions$v2_ove - all_versions$gt_ove)
all_versions$delta_v3 <- (all_versions$v3_ove - all_versions$gt_ove)

# Visualize OvE between versions and ground truth
ggplot(all_versions) + 
  geom_line(aes(x = gt_ove, y = v1_ove, color = "Version 1")) +
  geom_line(aes(x = gt_ove, y = v2_ove, color = "Version 2")) +
  geom_line(aes(x = gt_ove, y = v3_ove, color = "Version 3")) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  geom_abline(intercept = 0, slope = 1) +
  scale_color_manual(values = c("red", "blue", "green"),
                     labels = c("Version 1", "Version 2", "Version 3")) +
  labs(x = "Groundtruth", y = "ClustIRR", title = "OvE comparison")

# Visualize OvE between versions and ground truth wwith clonal expansion
ggplot(all_versions_exp) + 
  geom_line(aes(x = gt_ove_exp, y = v1_ove, color = "Version 1")) +
  geom_line(aes(x = gt_ove_exp, y = v2_ove, color = "Version 2")) +
  geom_line(aes(x = gt_ove_exp, y = v3_ove, color = "Version 3")) +
  scale_x_continuous(trans = 'log2') +
  scale_y_continuous(trans = 'log2') +
  geom_abline(intercept = 0, slope = 1) +
  scale_color_manual(values = c("red", "blue", "green"),
                     labels = c("Version 1", "Version 2", "Version 3")) +
  labs(x = "Groundtruth", y = "ClustIRR", title = "OvE comparison with exp")


```




```{r found_motifs}

m_v1 <- out_v1$clust$CDR3b$local$m[out_v1$clust$CDR3b$local$m$pass==TRUE,]
m_v2 <- out_v2$clust$CDR3b$local$m[out_v2$clust$CDR3b$local$m$pass==TRUE,]
m_v3 <- out_v3$clust$CDR3b$local$m[out_v3$clust$CDR3b$local$m$pass==TRUE,]

m_v1_exp <- out_v1_exp$clust$CDR3b$local$m[
  out_v1_exp$clust$CDR3b$local$m$pass==TRUE,]
m_v2_exp <- out_v2_exp$clust$CDR3b$local$m[
  out_v2_exp$clust$CDR3b$local$m$pass==TRUE,]
m_v3_exp <- out_v3_exp$clust$CDR3b$local$m[
  out_v3_exp$clust$CDR3b$local$m$pass==TRUE,]

df <- data.frame(version = c("1","2","3"),
                 found_motifs = c(nrow(m_v1), nrow(m_v2), nrow(m_v3)),
                 found_motifs_clexp = c(nrow(m_v1_exp), nrow(m_v2_exp), 
                                      nrow(m_v3_exp)))

knitr::kable(df)


```


## Check if implanted motifs are found

```{r local_motifs}
# inspect local motif enrichment results
# nrow(out_v1$clust$CDR3b$local$m[
#   out_v1$clust$CDR3b$local$m$pass==TRUE,])
# knitr::kable(out_v1$clust$CDR3b$local$m[
#   out_v1$clust$CDR3b$local$m$pass==TRUE,])
# 
# nrow(out_v2$clust$CDR3b$local$m[
#   out_v2$clust$CDR3b$local$m$pass==TRUE,])
# knitr::kable(out_v2$clust$CDR3b$local$m[
#   out_v2$clust$CDR3b$local$m$pass==TRUE,])
# 
# nrow(out_v3$clust$CDR3b$local$m[
#   out_v3$clust$CDR3b$local$m$pass==TRUE,])
# knitr::kable(out_v3$clust$CDR3b$local$m[
#   out_v3$clust$CDR3b$local$m$pass==TRUE,])

```
