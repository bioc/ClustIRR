---
title: "ClustIRR Benchmarking"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{benchmarking}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
require(ClustIRR)
require(ggplot2)
require(patchwork)

```

# TL;DR

- Motifs successfully detected accross all versions

- Global similarites also found (same algorithm for all versions)

- OvE values for all versions roughly comparable to ground truth
  - Small deviations caused by difference in ground truth calculation formula against FET in v2/3
  - Noisy motifs in v1 supposedly caused by bootstrapping vs gt calculation
  
- p-value of v1 seems to be lacking precision compared to v2/3
  - leads to fdr of version 1 being lower than v2/3
  - leads to v1 detecting more motifs than v2/3 (effectively lowered detection threshold)
  - after some testing seems to be related to formula of version 1


```{r create_input, echo=FALSE}
# Create input data

data("CD8")
CD8 <- data.frame(CDR3b = unique(CD8$CDR3b)) 
# simplification for benchmarking -> non-redundant sequences in reference

# data sample d0: 500 unique CDR3s drawn from reference database (CD8) with 10^4 CDR3s
set.seed(seed = 1234)
d_0 <- data.frame(CDR3b = CD8[sample(x = 1:nrow(CD8), size = 500, replace = FALSE),])


# data sample d1: enrich motif 'RQWW'
d_1 <- d_0
substr(x = d_1$CDR3b[1:20], start = 6, stop = 9) <- "RQWW"


# data sample d2: clonal expansion with two similar clones of hdist 1
d_2 <- d_1
clone_a <- data.frame(CDR3b = rep(x = "CATSRAAKPDGLAALETQYF", times = 15))
clone_b <- data.frame(CDR3b = rep(x = "CATSRAAKPDGLAALSTQYF", times = 15))
d_2 <- rbind(d_2, clone_a)
d_2 <- rbind(d_2, clone_b)

data_ref      <- CD8
data_sample   <- d_1
#data_sample_u <- unique(d_1) # already unique
data_sample_e <- d_2
data_sample_e_u <- unique(d_2)

rm(CD8, clone_a, clone_b, d_0, d_1, d_2)

```

## Input parameters

```{r create_parameters}
# v1 + v2 + v3
ks <- 4
cores <- parallel::detectCores()

control_input <- list(
  B = 1000,
  global_max_dist = 1,
  local_max_fdr = 0.05,
  local_min_ove = 2,
  local_min_o = 3,
  trim_flank_aa = 0,
  low_mem = FALSE,
  global_pairs = NULL)

```



```{r, ove_ground_truth, echo=FALSE}
# Calculate OvE Ground truth

# Compute OvE for data
# (f_sample / n_sample) / (f_ref / n_ref)
# f_ref/sample = motifs of a certain length found in ref / sample
# n_ref/sample = motif count of a certain length present in ref / sample

### when ove and p-value worked out, add flank trimming here
####
#####
######

# find motifs
f_ref        <- stringdist::qgrams(data_ref$CDR3b,        q=ks)
f_sample     <- stringdist::qgrams(data_sample$CDR3b,     q=ks)
f_sample_e   <- stringdist::qgrams(data_sample_e$CDR3b,   q=ks)
f_sample_e_u <- stringdist::qgrams(data_sample_e_u$CDR3b, q=ks)


# convert to data frames
f_ref        <- f_ref[1,]
f_ref        <- data.frame(motif=names(f_ref), 
                           f_ref=as.numeric(f_ref))
f_sample     <- f_sample[1,]
f_sample     <- data.frame(motif=names(f_sample), 
                           f_sample=as.numeric(f_sample))
f_sample_e   <- f_sample_e[1,]
f_sample_e   <- data.frame(motif=names(f_sample_e), 
                           f_sample=as.numeric(f_sample_e))
f_sample_e_u <- f_sample_e_u[1,]
f_sample_e_u <- data.frame(motif=names(f_sample_e_u), 
                           f_sample=as.numeric(f_sample_e_u))

# find motif counts
f_ref$n_ref           <- sum(f_ref$f_ref)
f_sample$n_sample     <- sum(f_sample$f_sample)
f_sample_e$n_sample   <- sum(f_sample_e$f_sample)
f_sample_e_u$n_sample <- sum(f_sample_e_u$f_sample)

# consolidate to motifs found in samples
f_ref_buf <- f_ref
f_ref     <- f_ref_buf[f_ref_buf$motif %in% f_sample$motif,     ]
f_ref_e   <- f_ref_buf[f_ref_buf$motif %in% f_sample_e$motif,   ]
f_ref_e_u <- f_ref_buf[f_ref_buf$motif %in% f_sample_e_u$motif, ]

gt_motifs     <- merge(f_sample,     f_ref,     by = "motif", all = TRUE)
gt_motifs_e   <- merge(f_sample_e,   f_ref_e,   by = "motif", all = TRUE)
gt_motifs_e_u <- merge(f_sample_e_u, f_ref_e_u, by = "motif", all = TRUE)

# replace f_ref NA with 0 and n_ref NA with n_ref
gt_motifs[is.na(gt_motifs[, "f_ref"]), "f_ref"] <- 0
gt_motifs[is.na(gt_motifs[, "n_ref"]), "n_ref"] <- gt_motifs$n_ref[1]

gt_motifs_e[is.na(gt_motifs_e[, "f_ref"]), "f_ref"] <- 0
gt_motifs_e[is.na(gt_motifs_e[, "n_ref"]), "n_ref"] <- gt_motifs_e$n_ref[1]

gt_motifs_e_u[is.na(gt_motifs_e_u[, "f_ref"]), "f_ref"] <- 0
gt_motifs_e_u[is.na(gt_motifs_e_u[, "n_ref"]), "n_ref"] <- gt_motifs_e_u$n_ref[1]

# compute ove
gt_motifs$ove <- (gt_motifs$f_sample / gt_motifs$n_sample) / 
  (gt_motifs$f_ref / gt_motifs$n_ref)

gt_motifs_e$ove <- (gt_motifs_e$f_sample / gt_motifs_e$n_sample) / 
  (gt_motifs_e$f_ref / gt_motifs_e$n_ref)

gt_motifs_e_u$ove <- (gt_motifs_e_u$f_sample / gt_motifs_e_u$n_sample) / 
  (gt_motifs_e_u$f_ref / gt_motifs_e_u$n_ref)

rm(f_ref, f_ref_e, f_ref_e_u, f_sample, f_sample_e, f_sample_e_u, f_ref_buf)

```




```{r run_clustirr, echo=FALSE}
# Cluster with ClustIRR versions


# data_sample with inserted motifs but without clonal expansion
out_v1 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)

out_v3 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

# data_sample with inserted motifs and clonal expansion
out_v1_e <- cluster_irr(data_sample = data_sample_e,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2_e <- cluster_irr(data_sample = data_sample_e,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)

out_v3_e <- cluster_irr(data_sample = data_sample_e,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

```



```{r prep_results,  echo=FALSE}
# Prepare results


o1  <- out_v1$clust$CDR3b$local$m
o2  <- out_v2$clust$CDR3b$local$m
o3  <- out_v3$clust$CDR3b$local$m
o1e <- out_v1_e$clust$CDR3b$local$m
o2e <- out_v2_e$clust$CDR3b$local$m
o3e <- out_v3_e$clust$CDR3b$local$m

# rename all columns except "motif"
names(o1)[names(o1) != "motif"] <- 
  paste(names(o1)[names(o1) != "motif"], "v1", sep="_")
names(o2)[names(o2) != "motif"] <- 
  paste(names(o2)[names(o2) != "motif"], "v2", sep="_")
names(o3)[names(o3) != "motif"] <- 
  paste(names(o3)[names(o3) != "motif"], "v3", sep="_")
names(o1e)[names(o1e) != "motif"] <- 
  paste(names(o1e)[names(o1e) != "motif"], "v1_e", sep="_")
names(o2e)[names(o2e) != "motif"] <- 
  paste(names(o2e)[names(o2e) != "motif"], "v2_e", sep="_")
names(o3e)[names(o3e) != "motif"] <- 
  paste(names(o3e)[names(o3e) != "motif"], "v3_e", sep="_")

names(gt_motifs)[names(gt_motifs) != "motif"] <- 
  paste(names(gt_motifs)[names(gt_motifs) != "motif"], "gt", sep="_")
names(gt_motifs_e)[names(gt_motifs_e) != "motif"] <- 
  paste(names(gt_motifs_e)[names(gt_motifs_e) != "motif"], "gt_e", sep="_")
names(gt_motifs_e_u)[names(gt_motifs_e_u) != "motif"] <- 
  paste(names(gt_motifs_e_u)[names(gt_motifs_e_u) != "motif"], "gt_e_u", sep="_")

# reduce to one big table
res <- Reduce(function (...) { merge(..., by = "motif", all = TRUE) },
                       list(o1, o2, o3, o1e, o2e, o3e, 
                            gt_motifs, gt_motifs_e, gt_motifs_e_u)) 

# compute delta values for ove
res$delta_ove_v1 <- (res$ove_v1 - res$ove_gt)
res$delta_ove_v2 <- (res$ove_v2 - res$ove_gt)
res$delta_ove_v3 <- (res$ove_v3 - res$ove_gt)
res$delta_ove_v1_e <- (res$ove_v1_e - res$ove_gt_e) # left in for comparison
res$delta_ove_v2_e <- (res$ove_v2_e - res$ove_gt_e) # ...
res$delta_ove_v3_e <- (res$ove_v3_e - res$ove_gt_e) 
res$delta_ove_v1_e_u <- (res$ove_v1_e - res$ove_gt_e_u)
res$delta_ove_v2_e_u <- (res$ove_v2_e - res$ove_gt_e_u)
res$delta_ove_v3_e_u <- (res$ove_v3_e - res$ove_gt_e_u)

# compute delta values for f_sample
res$delta_f_sample_v1 <- (res$f_sample_v1 - res$f_sample_gt)
res$delta_f_sample_v2 <- (res$f_sample_v2 - res$f_sample_gt)
res$delta_f_sample_v3 <- (res$f_sample_v3 - res$f_sample_gt)
res$delta_f_sample_v1_e <- (res$f_sample_v1_e - res$f_sample_gt_e)
res$delta_f_sample_v2_e <- (res$f_sample_v2_e - res$f_sample_gt_e)
res$delta_f_sample_v3_e <- (res$f_sample_v3_e - res$f_sample_gt_e)
res$delta_f_sample_v1_e_u <- (res$f_sample_v1_e - res$f_sample_gt_e_u)
res$delta_f_sample_v2_e_u <- (res$f_sample_v2_e - res$f_sample_gt_e_u)
res$delta_f_sample_v3_e_u <- (res$f_sample_v3_e - res$f_sample_gt_e_u)

# compute delta values for n_sample
res$delta_n_sample_v1 <- NA
res$delta_n_sample_v2 <- (res$n_sample_v2 - res$n_sample_gt)
res$delta_n_sample_v3 <- (res$n_sample_v3 - res$n_sample_gt)
res$delta_n_sample_v1_e <- NA
res$delta_n_sample_v2_e <- (res$n_sample_v2_e - res$n_sample_gt_e)
res$delta_n_sample_v3_e <- (res$n_sample_v3_e - res$n_sample_gt_e)
res$delta_n_sample_v1_e_u <- NA
res$delta_n_sample_v2_e_u <- (res$n_sample_v2_e - res$n_sample_gt_e_u)
res$delta_n_sample_v3_e_u <- (res$n_sample_v3_e - res$n_sample_gt_e_u)

# compute delta values for f_ref
res$delta_f_ref_v1 <- (res$mean_f_ref_v1 - res$f_ref_gt)
res$delta_f_ref_v2 <- (res$f_ref_v2 - res$f_ref_gt)
res$delta_f_ref_v3 <- (res$f_ref_v3 - res$f_ref_gt)
res$delta_f_ref_v1_e <- (res$mean_f_ref_v1_e - res$f_ref_gt_e)
res$delta_f_ref_v2_e <- (res$f_ref_v2_e - res$f_ref_gt_e)
res$delta_f_ref_v3_e <- (res$f_ref_v3_e - res$f_ref_gt_e)
res$delta_f_ref_v1_e_u <- (res$mean_f_ref_v1_e - res$f_ref_gt_e_u)
res$delta_f_ref_v2_e_u <- (res$f_ref_v2_e - res$f_ref_gt_e_u)
res$delta_f_ref_v3_e_u <- (res$f_ref_v3_e - res$f_ref_gt_e_u)

# compute delta values for n_ref
res$delta_n_ref_v1 <- NA
res$delta_n_ref_v2 <- (res$n_ref_v2 - res$n_ref_gt)
res$delta_n_ref_v3 <- (res$n_ref_v3 - res$n_ref_gt)
res$delta_n_ref_v1_e <- NA
res$delta_n_ref_v2_e <- (res$n_ref_v2_e - res$n_ref_gt_e)
res$delta_n_ref_v3_e <- (res$n_ref_v3_e - res$n_ref_gt_e)
res$delta_n_ref_v1_e_u <- NA
res$delta_n_ref_v2_e_u <- (res$n_ref_v2_e - res$n_ref_gt_e_u)
res$delta_n_ref_v3_e_u <- (res$n_ref_v3_e - res$n_ref_gt_e_u)

rm(o1, o2, o3, o1e, o2e, o3e, gt_motifs, gt_motifs_e, gt_motifs_e_u)

```


## Check implanted motifs

Implanted motif **RQWW** gets found in all versions. <br>
When using clonal expanded data_sample as input, only version 3 finds more motifs. <br>
Version 1 and 2 find less motifs when expanded because of motifs near threshold, see below in section about **p-value**/**fdr**. <br>
Reason for version 1 finding more motifs when not expanded could be **p-value** being calculated differently

```{r found_motifs, echo=FALSE}

m_v1 <- out_v1$clust$CDR3b$local$m[out_v1$clust$CDR3b$local$m$pass==TRUE,]
m_v2 <- out_v2$clust$CDR3b$local$m[out_v2$clust$CDR3b$local$m$pass==TRUE,]
m_v3 <- out_v3$clust$CDR3b$local$m[out_v3$clust$CDR3b$local$m$pass==TRUE,]

m_v1_e <- out_v1_e$clust$CDR3b$local$m[
  out_v1_e$clust$CDR3b$local$m$pass==TRUE,]
m_v2_e <- out_v2_e$clust$CDR3b$local$m[
  out_v2_e$clust$CDR3b$local$m$pass==TRUE,]
m_v3_e <- out_v3_e$clust$CDR3b$local$m[
  out_v3_e$clust$CDR3b$local$m$pass==TRUE,]

df <- data.frame(version = c("1","2","3"),
                 no_exp = c(nrow(m_v1), nrow(m_v2), nrow(m_v3)),
                 exp = c(nrow(m_v1_e), nrow(m_v2_e), 
                                      nrow(m_v3_e)))

knitr::kable(df, caption="found motifs")

# inspect local motif enrichment results
knitr::kable(m_v1[order(-m_v1$f_sample),], caption="v1")
knitr::kable(m_v2[order(-m_v2$f_sample),], caption="v2")
knitr::kable(m_v3[order(-m_v3$f_sample),], caption="v3")
knitr::kable(m_v1_e[order(-m_v1_e$f_sample),], caption="v1 exp")
knitr::kable(m_v2_e[order(-m_v2_e$f_sample),], caption="v2 exp")
knitr::kable(m_v3_e[order(-m_v3_e$f_sample),], caption="v3 exp")



```
## Check global sequences

Inserted sequences **CATSRAAKPDGLAALETQYF** and **CATSRAAKPDGLAALSTQYF** are found by all versions (same algorithm).

```{r global_motifs, echo=FALSE}
# inspect which CDR3bs are globally similar

df <- data.frame(version = c("1","2","3"),
                 no_exp = c(nrow(m_v1), nrow(m_v2), nrow(m_v3)),
                 exp = c(nrow(m_v1_e), nrow(m_v2_e), 
                                      nrow(m_v3_e)))

knitr::kable(out_v3$clust$CDR3b$global, caption="without clonal expansion")
knitr::kable(out_v3_e$clust$CDR3b$global, caption="with clonal expansion")

rm(df, m_v1, m_v2, m_v3, m_v1_e, m_v2_e, m_v3_e)

```

## Compare p-values and fdr

Both **p-value** and **fdr** seem to be comparable between versions. <br>

**OvE** also looks reasonable for found motifs. <br>

**p-value** of version 1 seems to cut off value < 0.000, possible reason for more found motifs

```{r p_fdr, echo=FALSE}
# fdr        <= local_max_fdr
# ove        >= local_min_ove
# f_sample   >= local_min_o

# thresholds
df <- data.frame(local_max_fdr = control_input$local_max_fdr,
                 local_min_ove = control_input$local_min_ove,
                 local_min_o   = control_input$local_min_o)

knitr::kable(df, caption="selection thresholds")

# subset selected motifs
r <- res[(res$pass_v1==TRUE & !is.na(res$pass_v1) ) |
           (res$pass_v2==TRUE & !is.na(res$pass_v2) ) |
           (res$pass_v3==TRUE & !is.na(res$pass_v3) ),
         c("motif", "pass_v1", "pass_v2", "pass_v3",
           "p_value_v1", "p_value_v2", "p_value_v3", 
           "fdr_v1", "fdr_v2",   "fdr_v3", 
           #"mean_f_ref_v1", "f_ref_v2", "f_ref_v3", 
           "f_sample_v1", "f_sample_v2", "f_sample_v3",
           "ove_v1", "ove_v2", "ove_v3")]
# sort
r <- r[order(-r$pass_v2),]

# inspect local motif enrichment results
knitr::kable(r, caption="p-value / fdr comparison")

# subset selected motifs
r <- res[(res$pass_v1_e==TRUE & !is.na(res$pass_v1_e) ) |
           (res$pass_v2_e==TRUE & !is.na(res$pass_v2_e) ) |
           (res$pass_v3_e==TRUE & !is.na(res$pass_v3_e) ),
         c("motif", "pass_v1_e", "pass_v2_e", "pass_v3_e",
           "p_value_v1_e", "p_value_v2_e", "p_value_v3_e", 
           "fdr_v1_e", "fdr_v2_e",   "fdr_v3_e", 
           #"mean_f_ref_v1", "f_ref_v2", "f_ref_v3", 
           "f_sample_v1_e", "f_sample_v2_e", "f_sample_v3_e",
           "ove_v1_e", "ove_v2_e", "ove_v3_e")]
# sort
r <- r[order(-r$pass_v3_e, -r$pass_v1_e),]

# inspect local motif enrichment results
knitr::kable(r, caption="p-value / fdr comparison - expanded")

rm(df, r)

```

## Investigate OvE values

For found motifs of version 1 against ground truth, OvE values look reasonably comparable.

```{r ove_comparison_v1, echo=FALSE}

df <- res[res$pass_v1 == TRUE & !is.na(res$pass_v1),]
df <- df[c("motif", "ove_gt", "ove_v1", "delta_ove_v1", "pass_v1")]
knitr::kable(df[order(-df$ove_v1),], caption="v1 found motifs OvE vs gt OvE")

df <- res[res$pass_v1_e == TRUE & !is.na(res$pass_v1_e),]
df <- df[c("motif", "ove_gt_e_u", "ove_v1_e", "delta_ove_v1_e_u", "pass_v1_e")]
knitr::kable(df[order(-df$ove_v1_e),], caption="v1 found motifs OvE vs gt OvE - with clonal expansion")

rm(df)

```

For found motifs of version 2 against ground truth, OvE values look comparable (only one value to be seen, though).

```{r ove_comparison_v2, echo=FALSE}

df <- res[res$pass_v2 == TRUE & !is.na(res$pass_v2),]
df <- df[c("motif", "ove_gt", "ove_v2", "delta_ove_v2", "pass_v2")]
knitr::kable(df[order(-df$ove_v2),], caption="v2 found motifs OvE vs gt OvE")

df <- res[res$pass_v2_e == TRUE & !is.na(res$pass_v2_e),]
df <- df[c("motif", "ove_gt_e_u", "ove_v2_e", "delta_ove_v2_e_u", "pass_v2_e")]
knitr::kable(df[order(-df$ove_v2_e),], caption="v2 found motifs OvE vs gt OvE - with clonal expansion")

rm(df)

```

For found motifs of version 3 against ground truth, OvE values look comparable except the highest value.

```{r ove_comparison_v3, echo=FALSE}

df <- res[res$pass_v3 == TRUE & !is.na(res$pass_v3),]
df <- df[c("motif", "ove_gt", "ove_v3", "delta_ove_v3", "pass_v3")]
knitr::kable(df[order(-df$ove_v3),], caption="v3 found motifs OvE vs gt OvE")

df <- res[res$pass_v3_e == TRUE & !is.na(res$pass_v3_e),]
df <- df[c("motif", "ove_gt_e", "ove_v3_e", "delta_ove_v3_e", "pass_v3_e")]
knitr::kable(df[order(-df$ove_v3_e),], caption="v3 found motifs OvE vs gt OvE - with clonal expansion")


rm(df)

```

When visualized all motifs against Ground Truth, all versions seem to be comparable. <br>
Version 1 shows some noise variations, supposedly caused by different OvE calculation based on bootstrapping.

```{r ove_comparison_all, fig.width=10, fig.height=10, fig.align='center', echo=FALSE}
g1a <- ggplot(res) + 
  geom_point(aes(x = ove_v1, y = ove_gt)) +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "ClustIRR v1", y = "Groundtruth", title = "OvE v1 vs GT")
g2a <- ggplot(res) + 
  geom_point(aes(x = ove_v2, y = ove_gt)) +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "ClustIRR v2", y = "Groundtruth", title = "OvE v2 vs GT")
g3a <- ggplot(res) + 
  geom_point(aes(x = ove_v3, y = ove_gt)) +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "ClustIRR v3", y = "Groundtruth", title = "OvE v3 vs GT")
g1b <- ggplot(res) + 
  geom_point(aes(x = ove_v1_e, y = ove_gt_e_u)) +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "ClustIRR v1", y = "Groundtruth", title = "OvE v1 vs GT - with clonal expansion")
g2b <- ggplot(res) + 
  geom_point(aes(x = ove_v2_e, y = ove_gt_e_u)) +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "ClustIRR v2", y = "Groundtruth", title = "OvE v2 vs GT - with clonal expansion")
g3b <- ggplot(res) + 
  geom_point(aes(x = ove_v3_e, y = ove_gt_e)) +
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "ClustIRR v3", y = "Groundtruth", title = "OvE v3 vs GT - with clonal expansion") 


(g1a + g2a + g3a)  / (g1b + g2b + g3b)

# f_ref     <- f_ref[f_ref$motif %in% f_sample$motif,     ]

# knitr::kable(df[order(-df$ove_v1),], caption="v1 found motifs OvE vs gt OvE")

rm(g1a, g1b, g2a, g2b, g3a, g3b)

```

## Check Delta Counts (sanity check for ground truth comparability)

Comparing delta between versions and ground truth versions. <br>

Suffix _e: compared with ground truth expanded <br> 
Suffix _e_u: compared with ground truth expanded and reduced to unique values. <br> <br>

Version 1 has no **n_sample** / **n_ref** output, **OvE** computed with bootstrapping results. <br>

**OvE** different to GT in all versions, but mostly small deviations (see **OvE** section). <br>

```{r check_deltas, echo=FALSE}

# ove
ove_v1 <- res[(!is.na(res$delta_ove_v1) & res$delta_ove_v1 != 0),
              c("motif", "ove_v1", "ove_gt", "delta_ove_v1")]
ove_v2 <- res[(!is.na(res$delta_ove_v2) & res$delta_ove_v2 != 0),
              c("motif", "ove_v2", "ove_gt", "delta_ove_v2")]
ove_v3 <- res[(!is.na(res$delta_ove_v3) & res$delta_ove_v3 != 0),
              c("motif", "ove_v3", "ove_gt", "delta_ove_v3")]

ove_v1e <- res[(!is.na(res$delta_ove_v1_e) & res$delta_ove_v1_e != 0),
              c("motif", "ove_v1_e", "ove_gt_e", "delta_ove_v1_e")]
ove_v2e <- res[(!is.na(res$delta_ove_v2_e) & res$delta_ove_v2_e != 0),
              c("motif", "ove_v2_e", "ove_gt_e", "delta_ove_v2_e")]
ove_v3e <- res[(!is.na(res$delta_ove_v3_e) & res$delta_ove_v3_e != 0),
              c("motif", "ove_v3_e", "ove_gt_e", "delta_ove_v3_e")]

ove_v1eu <- res[(!is.na(res$delta_ove_v1_e_u) & res$delta_ove_v1_e_u != 0),
              c("motif", "ove_v1_e", "ove_gt_e_u", "delta_ove_v1_e_u")]
ove_v2eu <- res[(!is.na(res$delta_ove_v2_e_u) & res$delta_ove_v2_e != 0),
              c("motif", "ove_v2_e", "ove_gt_e_u", "delta_ove_v2_e_u")]
ove_v3eu <- res[(!is.na(res$delta_ove_v3_e_u) & res$delta_ove_v3_e != 0),
              c("motif", "ove_v3_e", "ove_gt_e_u", "delta_ove_v3_e_u")]

# f_sample
fs_v1 <- res[(!is.na(res$delta_f_sample_v1) & res$delta_f_sample_v1 != 0), 
             c("motif", "f_sample_v1", "f_sample_gt")]
fs_v2 <- res[(!is.na(res$delta_f_sample_v2) & res$delta_f_sample_v2 != 0), 
             c("motif", "f_sample_v2", "f_sample_gt")]
fs_v3 <- res[(!is.na(res$delta_f_sample_v3) & res$delta_f_sample_v3 != 0), 
             c("motif", "f_sample_v3", "f_sample_gt")]

fs_v1e <- res[(!is.na(res$delta_f_sample_v1_e) & res$delta_f_sample_v1_e != 0), 
             c("motif", "f_sample_v1_e", "f_sample_gt_e")]
fs_v2e <- res[(!is.na(res$delta_f_sample_v2_e) & res$delta_f_sample_v2_e != 0), 
             c("motif", "f_sample_v2_e", "f_sample_gt_e")]
fs_v3e <- res[(!is.na(res$delta_f_sample_v3_e) & res$delta_f_sample_v3_e != 0), 
             c("motif", "f_sample_v3_e", "f_sample_gt_e")]

fs_v1eu <- res[(!is.na(res$delta_f_sample_v1_e_u) & res$delta_f_sample_v1_e_u != 0), 
             c("motif", "f_sample_v1_e", "f_sample_gt_e_u")]
fs_v2eu <- res[(!is.na(res$delta_f_sample_v2_e_u) & res$delta_f_sample_v2_e_u != 0), 
             c("motif", "f_sample_v2_e", "f_sample_gt_e_u")]
fs_v3eu <- res[(!is.na(res$delta_f_sample_v3_e_u) & res$delta_f_sample_v3_e_u != 0), 
             c("motif", "f_sample_v3_e", "f_sample_gt_e_u")]

# n_sample
ns_v2 <- res[(!is.na(res$delta_n_sample_v2) & res$delta_n_sample_v2 != 0), 
             c("motif", "n_sample_v2", "n_sample_gt")]
ns_v3 <- res[(!is.na(res$delta_n_sample_v3) & res$delta_n_sample_v3 != 0), 
             c("motif", "n_sample_v3", "n_sample_gt")]
ns_v2e <- res[(!is.na(res$delta_n_sample_v2_e) & res$delta_n_sample_v2_e != 0), 
             c("motif", "n_sample_v2_e", "n_sample_gt_e")]
ns_v3e <- res[(!is.na(res$delta_n_sample_v3_e) & res$delta_n_sample_v3_e != 0), 
             c("motif", "n_sample_v3_e", "n_sample_gt_e")]
ns_v2eu <- res[(!is.na(res$delta_n_sample_v2_e_u) & res$delta_n_sample_v2_e_u != 0), 
             c("motif", "n_sample_v2_e", "n_sample_gt_e_u")]
ns_v3eu <- res[(!is.na(res$delta_n_sample_v3_e_u) & res$delta_n_sample_v3_e_u != 0), 
             c("motif", "n_sample_v3_e", "n_sample_gt_e_u")]

# f_ref
fr_v1 <- res[(!is.na(res$delta_f_ref_v1) & res$delta_f_ref_v1 != 0), 
             c("motif", "mean_f_ref_v1", "f_ref_gt")]
fr_v2 <- res[(!is.na(res$delta_f_ref_v2) & res$delta_f_ref_v2 != 0), 
             c("motif", "f_ref_v2", "f_ref_gt")]
fr_v3 <- res[(!is.na(res$delta_f_ref_v3) & res$delta_f_ref_v3 != 0), 
             c("motif", "f_ref_v3", "f_ref_gt")]

fr_v1e <- res[(!is.na(res$delta_f_ref_v1_e) & res$delta_f_ref_v1_e != 0), 
             c("motif", "mean_f_ref_v1_e", "f_ref_gt_e")]
fr_v2e <- res[(!is.na(res$delta_f_ref_v2_e) & res$delta_f_ref_v2_e != 0), 
             c("motif", "f_ref_v2_e", "f_ref_gt_e")]
fr_v3e <- res[(!is.na(res$delta_f_ref_v3_e) & res$delta_f_ref_v3_e != 0), 
             c("motif", "f_ref_v3_e", "f_ref_gt_e")]

fr_v1eu <- res[(!is.na(res$delta_f_ref_v1_e_u) & res$delta_f_ref_v1_e_u != 0), 
             c("motif", "mean_f_ref_v1_e", "f_ref_gt_e_u")]
fr_v2eu <- res[(!is.na(res$delta_f_ref_v2_e_u) & res$delta_f_ref_v2_e_u != 0), 
             c("motif", "f_ref_v2_e", "f_ref_gt_e_u")]
fr_v3eu <- res[(!is.na(res$delta_f_ref_v3_e_u) & res$delta_f_ref_v3_e_u != 0), 
             c("motif", "f_ref_v3_e", "f_ref_gt_e_u")]

# n_ref
nr_v2 <- res[(!is.na(res$delta_n_ref_v2) & res$delta_n_ref_v2 != 0), 
             c("motif", "n_ref_v2", "n_ref_gt")]
nr_v3 <- res[(!is.na(res$delta_n_ref_v3) & res$delta_n_ref_v3 != 0), 
             c("motif", "n_ref_v3", "n_ref_gt")]
nr_v2e <- res[(!is.na(res$delta_n_ref_v2_e) & res$delta_n_ref_v2_e != 0), 
             c("motif", "n_ref_v2_e", "n_ref_gt_e")]
nr_v3e <- res[(!is.na(res$delta_n_ref_v3_e) & res$delta_n_ref_v3_e != 0), 
             c("motif", "n_ref_v3_e", "n_ref_gt_e")]
nr_v2eu <- res[(!is.na(res$delta_n_ref_v2_e_u) & res$delta_n_ref_v2_e_u != 0), 
             c("motif", "n_ref_v2_e", "n_ref_gt_e_u")]
nr_v3eu <- res[(!is.na(res$delta_n_ref_v3_e_u) & res$delta_n_ref_v3_e_u != 0), 
             c("motif", "n_ref_v3_e", "n_ref_gt_e_u")]

```


For data_sample without clonal expansion in all versions **f_sample**, **n_sample** and **n_ref** no difference to ground truth.<br>

```{r check_deltas_sample, echo=FALSE}

df <- data.frame(version = c("1","2","3"),
                 ove = c(nrow(ove_v1), nrow(ove_v2), nrow(ove_v3)),
                 f_sample = c(nrow(fs_v1), nrow(fs_v2), nrow(fs_v3)),
                 n_sample = c(NA, nrow(ns_v2), nrow(ns_v3)),
                 n_ref = c(NA, nrow(nr_v2), nrow(nr_v3))
                 )

knitr::kable(df, caption="number of rows that are different from ground truth computed with data_sample")

```

As expected, for data_sample with clonal expansion and ground truth computed without reduction to unique sequences, **f_sample_e** and **n_sample_e** are different between ground truth and version 1/2, but not version 3. <br>

```{r check_deltas_sample_e, echo=FALSE}
df <- data.frame(version = c("1","2","3"),
                 ove_e = c(nrow(ove_v1e), nrow(ove_v2e), nrow(ove_v3e)),
                 f_sample_e = c(nrow(fs_v1e), nrow(fs_v2e), nrow(fs_v3e)),
                 n_sample_e = c(NA, nrow(ns_v2e), nrow(ns_v3e)),
                 n_ref_e = c(NA, nrow(nr_v2e), nrow(nr_v3e))
                 )

knitr::kable(df, caption="number of rows that are different from ground truth computed with expanded data_sample")

```

Also as expected, when using the ground truth calculated for data_sample with clonal expansion and reduction to unique sequences, **f_sample** and **n_sample** match between version 1/2 and ground truth, but not version 3.

```{r check_deltas_sample_e_u, echo=FALSE}
df <- data.frame(version = c("1","2","3"),
                 ove_e_u = c(nrow(ove_v1eu), nrow(ove_v2eu), nrow(ove_v3eu)),
                 f_sample_e_u = c(nrow(fs_v1eu), nrow(fs_v2eu), nrow(fs_v3eu)),
                 n_sample_e_u = c(NA, nrow(ns_v2eu), nrow(ns_v3eu)),
                 n_ref_e_u = c(NA, nrow(nr_v2eu), nrow(nr_v3eu))
                 )

knitr::kable(df, caption="number of rows that are different from ground truth computed with expanded data_sample, reduced to unique sequences")

rm(df, ove_v1, ove_v2, ove_v3, ove_v1e, ove_v2e, ove_v3e, ove_v1eu, ove_v2eu, ove_v3eu, 
   fr_v1, fr_v1e, fr_v1eu, fr_v2, fr_v2e, fr_v2eu, fr_v3, fr_v3e, fr_v3eu,
   fs_v1, fs_v1e, fs_v1eu, fs_v2, fs_v2e, fs_v2eu, fs_v3, fs_v3e, fs_v3eu,
   nr_v2, nr_v2e, nr_v2eu, nr_v3, nr_v3e, nr_v3eu,
   ns_v2, ns_v2e, ns_v2eu, ns_v3, ns_v3e, ns_v3eu)

```