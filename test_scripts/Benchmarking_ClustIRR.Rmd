---
title: "Benchmarking"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{benchmarking}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
require(ClustIRR)
require(ggplot2)
require(patchwork)
require(immuneSIM)

```


# Create input data

```{r create_input_data}

# set seed for reproducibility
set.seed(1234)

# ## create artificial reference repertoire with immuneSIM package
# data_ref_full <- immuneSIM(
#   number_of_seqs = 10000,       # number of simulated sequences
#   species = "hs",               # species (human)
#   receptor = "tr",              # receptor-type (t-cells)
#   chain = "b",                  # chain type (beta chain)
#   max_cdr3_length = 100,        # max cdr3 length
#   min_cdr3_length = 6,          # min cdr3 length
#   user_defined_alpha = 1.1,     # clone count distribution
#   verbose = TRUE)               # output progress
# 
# save(data_ref_full, file="immuneSIM/immuneSIM_10000seqs.RData")

# load precomputed repertoire
load("immuneSIM/immuneSIM_10000seqs.RData")

## insert motifs

# # create n random motifs of length k
# motifs <- list(
#   "n" = 3,                      # 3 different motifs
#   "k" = 3,                      # 3mer's
#   "freq" = c(0.05, 0.25, 0.4))  # occurrence probabilities

# create motifs manually
motifs <- data.frame(aa   = c("CCC","FFF"),
                    nt   = c("gccgcc","tttttt"),
                    freq = c(0.2,0.1))

data_sample_full <- motif_implantation(
  sim_repertoire = data_ref_full,  # source repertoire
  motif = motifs,                  # motifs to implant
  fixed_pos = 5)                   # insert at random (0) or fixed (n) position

# random subset motif enriched dataset to simulate realistic sampling
data_sample_full <- data.frame(data_sample_full[sample(1:nrow(data_sample_full),
                                             500,
                                             replace = FALSE),])

# Reduce to CDR3b sequence
data_ref    <- data.frame(data_ref_full[,4])
data_sample <- data.frame(data_sample_full[,4])
names(data_ref)[1]    <- "CDR3b"
names(data_sample)[1] <- "CDR3b"

## Insert global sequence for global check

# Random sequence for clonal expansion simulation
cl_expansion <- c(CDR3b = "QQQQTTTQQQQTTT")

# Insert 1 time in data_ref for reference
data_ref <- rbind(data_ref, cl_expansion) 

# Insert 20 times in sample
data_sample_exp <- data_sample
for(i in 0:199) {
  data_sample_exp <- rbind(data_sample_exp, cl_expansion)
}

rm(i, cl_expansion)

```



# Prepare input parameters

```{r create_parameters}

cores <- parallel::detectCores()

# v1 + v2 + v3
ks <- c(2, 3, 4)
B <- 1000
control_input <- list(
  B = B,
  global_max_dist = 1,
  local_max_fdr = 0.05,
  local_min_ove = 2,
  local_min_o = 3,
  trim_flank_aa = 3,
  low_mem = FALSE,
  global_pairs = NULL)


```

# Cluster with ClustIRR versions

```{r run_clustirr}
# data_sample with inserted motifs but without clonal expansion
out_v1 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)


out_v3 <- cluster_irr(data_sample = data_sample,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

# data_sample with inserted motifs and clonal expansion
out_v1_exp <- cluster_irr(data_sample = data_sample_exp,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 1,
                control = control_input)

out_v2_exp <- cluster_irr(data_sample = data_sample_exp,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 2,
                control = control_input)


out_v3_exp <- cluster_irr(data_sample = data_sample_exp,
                data_ref = data_ref,
                ks = ks,
                cores = cores,
                version = 3,
                control = control_input)

# put in the same data for ref and sample
out_v1_i <- cluster_irr(data_sample = data_sample,
                  data_ref = data_sample,
                  ks = ks,
                  cores = cores,
                  version = 1,
                  control = control_input)

out_v2_i <- cluster_irr(data_sample = data_sample,
                  data_ref = data_sample,
                  ks = ks,
                  cores = cores,
                  version = 2,
                  control = control_input)


out_v3_i <- cluster_irr(data_sample = data_sample,
                  data_ref = data_sample,
                  ks = ks,
                  cores = cores,
                  version = 3,
                  control = control_input)

rm(B, cores, ks, control_input)

```


# Compare results

```{r compare_results}

# prepare for visualization
e_v1 <- out_v1$clust$CDR3b$local$m
colnames(e_v1)[which(colnames(e_v1) == 'ove')]     <- 'OvE_ClustIRR1'
e_v1_i <- out_v1_i$clust$CDR3b$local$m
colnames(e_v1_i)[which(colnames(e_v1_i) == 'ove')] <- 'OvE_ClustIRR1_id'
e_v1_exp <- out_v1_exp$clust$CDR3b$local$m
colnames(e_v1_exp)[which(colnames(e_v1_exp) == 'ove')] <- 'OvE_ClustIRR1_exp'

e_v2 <- out_v2$clust$CDR3b$local$m
colnames(e_v2)[which(colnames(e_v2) == 'ove')]     <- 'OvE_ClustIRR2'
e_v2_i <- out_v2_i$clust$CDR3b$local$m
colnames(e_v2_i)[which(colnames(e_v2_i) == 'ove')] <- 'OvE_ClustIRR2_id'
e_v2_exp <- out_v2_exp$clust$CDR3b$local$m
colnames(e_v2_exp)[which(colnames(e_v2_exp) == 'ove')] <- 'OvE_ClustIRR2_exp'

e_v3 <- out_v3$clust$CDR3b$local$m
colnames(e_v3)[which(colnames(e_v3) == 'ove')]     <- 'OvE_ClustIRR3'
e_v3_i <- out_v3_i$clust$CDR3b$local$m
colnames(e_v3_i)[which(colnames(e_v3_i) == 'ove')] <- 'OvE_ClustIRR3_id'
e_v3_exp <- out_v3_exp$clust$CDR3b$local$m
colnames(e_v3_exp)[which(colnames(e_v3_exp) == 'ove')] <- 'OvE_ClustIRR3_exp'


```


## Identical vs different input & version OVE comparison

```{r identical_vs_different, fig.width=10, fig.height=10, fig.align='center'}

## identical input

# ClustIRR v1 test with identical input
c_v1_i <- merge(e_v1, e_v1_i, by = "motif", all = TRUE)
c_v1_i[is.na(c_v1_i)] <- -1
g_v1 <- ggplot(c_v1_i, aes(x = OvE_ClustIRR1_id, y = OvE_ClustIRR1)) +
  geom_point() +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v1 - identical versus different input")

# ClustIRR v2 test with identical input
c_v2_i <- merge(e_v2, e_v2_i, by = "motif", all = TRUE)
c_v2_i[is.na(c_v2_i)] <- -1
g_v2 <- ggplot(c_v2_i, aes(x = OvE_ClustIRR2_id, y = OvE_ClustIRR2)) +
  geom_point() +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v2 - identical versus different input")

# ClustIRR v3 test with identical input
c_v3_i <- merge(e_v3, e_v3_i, by = "motif", all = TRUE)
c_v3_i[is.na(c_v3_i)] <- -1
g_v3 <- ggplot(c_v3_i, aes(x = OvE_ClustIRR3_id, y = OvE_ClustIRR3)) +
  geom_point() +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v3 - identical versus different input")

## motifs expanded

# ClustIRR v1 vs ClustIRR v2
c_v1_2 <- merge(e_v1, e_v2, by = "motif", all = TRUE)
c_v1_2[is.na(c_v1_2)] <- -1
g_gl1_gl2 <- ggplot(c_v1_2, aes(x = OvE_ClustIRR1, y = OvE_ClustIRR2)) +
  geom_point() +
  geom_smooth(method = lm , color = "blue", fill = "red") +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v1 vs v2 - motifs enriched")

# ClustIRR v1 vs ClustIRR v3
c_v1_3 <- merge(e_v1, e_v3, by = "motif", all = TRUE)
c_v1_3[is.na(c_v1_3)] <- -1
g_gl1_gl3 <- ggplot(c_v1_3, aes(x = OvE_ClustIRR1, y = OvE_ClustIRR3)) +
  geom_point() +
  geom_smooth(method = lm , color = "blue", fill = "red") +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v1 vs v3 - motifs enriched")

# ClustIRR v2 vs ClustIRR v3
c_v2_3 <- merge(e_v2, e_v3, by = "motif", all = TRUE)
c_v2_3[is.na(c_v2_3)] <- -1
g_gl2_gl3 <- ggplot(c_v2_3, aes(x = OvE_ClustIRR2, y = OvE_ClustIRR3)) +
  geom_point() +
  geom_smooth(method = lm , color = "blue", fill = "red") +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v2 vs v3 - motifs enriched")

## motifs expanded + clonal expansion

# ClustIRR v1 vs ClustIRR v2
c_v1_2_exp <- merge(e_v1_exp, e_v2_exp, by = "motif", all = TRUE)
c_v1_2_exp[is.na(c_v1_2_exp)] <- -1
g_gl1_gl2_exp <- ggplot(c_v1_2_exp, aes(x = OvE_ClustIRR1_exp, 
                                        y = OvE_ClustIRR2_exp)) +
  geom_point() +
  geom_smooth(method = lm , color = "blue", fill = "red") +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v1 vs v2 - motifs enriched + clonal expansion")

# ClustIRR v1 vs ClustIRR v3
c_v1_3_exp <- merge(e_v1_exp, e_v3_exp, by = "motif", all = TRUE)
c_v1_3_exp[is.na(c_v1_3_exp)] <- -1
g_gl1_gl3_exp <- ggplot(c_v1_3_exp, aes(x = OvE_ClustIRR1_exp, 
                                        y = OvE_ClustIRR3_exp)) +
  geom_point() +
  geom_smooth(method = lm , color = "blue", fill = "red") +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v1 vs v3 - motifs enriched + clonal expansion")

# ClustIRR v2 vs ClustIRR v3
c_v2_3_exp <- merge(e_v2_exp, e_v3_exp, by = "motif", all = TRUE)
c_v2_3_exp[is.na(c_v2_3_exp)] <- -1
g_gl2_gl3_exp <- ggplot(c_v2_3_exp, aes(x = OvE_ClustIRR2_exp, 
                                        y = OvE_ClustIRR3_exp)) +
  geom_point() +
  geom_smooth(method = lm , color = "blue", fill = "red") +
  geom_abline(linewidth = 0.5, color = "gray") +
  ggtitle("v2 vs v3 - motifs enriched + clonal expansion")

( g_v1 + g_v2 + g_v3 ) / 
  (g_gl1_gl2 + g_gl1_gl3 + g_gl2_gl3) / 
  (g_gl1_gl2_exp + g_gl1_gl3_exp + g_gl2_gl3_exp)


rm(e_v1, e_v2, e_v3, 
   e_v1_i, e_v2_i, e_v3_i, 
   e_v1_exp, e_v2_exp, e_v3_exp,
   g_v1, g_v2, g_v3, 
   g_gl1_gl2, g_gl1_gl3, g_gl2_gl3, 
   g_gl1_gl2_exp, g_gl1_gl3_exp, g_gl2_gl3_exp,
   c_v1_i, c_v2_i, c_v3_i, 
   c_v1_2, c_v1_3, c_v2_3, 
   c_v1_2_exp, c_v1_3_exp, c_v2_3_exp) 

``` 
#### OVE interpretation: 
#### v1 seems to finds less
#### v3 finds more than v2 when artificial clonal expansion is inserted


## Check if implanted motifs are found in identical input 
#### should be empty


```{r local_motifs_i}
# inspect local motif enrichment results for identical input
knitr::kable(out_v1_i$clust$CDR3b$local$m[
  out_v1_i$clust$CDR3b$local$m$pass==TRUE,])

knitr::kable(out_v2_i$clust$CDR3b$local$m[
  out_v2_i$clust$CDR3b$local$m$pass==TRUE,])

knitr::kable(out_v3_i$clust$CDR3b$local$m[
  out_v3_i$clust$CDR3b$local$m$pass==TRUE,])
```

## Check if implanted motifs are found
#### v1 does not find any motif


```{r local_motifs}
# inspect local motif enrichment results
knitr::kable(out_v1$clust$CDR3b$local$m[
  out_v1$clust$CDR3b$local$m$pass==TRUE,])

knitr::kable(out_v2$clust$CDR3b$local$m[
  out_v2$clust$CDR3b$local$m$pass==TRUE,])

knitr::kable(out_v3$clust$CDR3b$local$m[
  out_v3$clust$CDR3b$local$m$pass==TRUE,])

```

#### All V1 local motifs for reference


```{r local_motifs_v1_a}
# inspect local motif enrichment results
knitr::kable(out_v1$clust$CDR3b$local$m)

```
## Check what happens when clonal expansion is added
#### v1 does not find any motif


```{r local_motifs_exp}
# inspect local motif enrichment results
knitr::kable(out_v1_exp$clust$CDR3b$local$m[
  out_v1_exp$clust$CDR3b$local$m$pass==TRUE,])

knitr::kable(out_v2_exp$clust$CDR3b$local$m[
  out_v2_exp$clust$CDR3b$local$m$pass==TRUE,])

knitr::kable(out_v3_exp$clust$CDR3b$local$m[
  out_v3_exp$clust$CDR3b$local$m$pass==TRUE,])

```

#### All V1 local motifs for reference with clonal expansion


```{r local_motifs_v1}
# inspect local motif enrichment results
knitr::kable(out_v1_exp$clust$CDR3b$local$m)

```

## Check global clustering


```{r global_motifs}
# inspect which CDR3bs are globally similar
knitr::kable(out_v1_i$clust$CDR3b$global)
knitr::kable(out_v2_i$clust$CDR3b$global)
knitr::kable(out_v3_i$clust$CDR3b$global)

knitr::kable(out_v1$clust$CDR3b$global)
knitr::kable(out_v2$clust$CDR3b$global)
knitr::kable(out_v3$clust$CDR3b$global)

knitr::kable(out_v1_exp$clust$CDR3b$global)
knitr::kable(out_v2_exp$clust$CDR3b$global)
knitr::kable(out_v3_exp$clust$CDR3b$global)


```

