---
title: "visualization test"
output: html_notebook
---

```{r libs}
library(ClustIRR)
library(knitr)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(visNetwork)
library(turboGliph)
library(igraph)

```

# Motivation

checking get_edges visualization; not sure if plotting error or double global connections

# Preparation

create input with and without clones

```{r data}

# load package input data
data("CD8")

# set the random seed for sampling reproducibility
set.seed(987)

# sample 500 sequences from the reference dataset as sample dataset
data_sample <- data.frame(CDR3b = CD8[sample(x = 1:nrow(CD8), 
                                             size = 100, 
                                             replace = FALSE),])

# artificially enrich motif 'RQWW' inside sample dataset
substr(x = data_sample$CDR3b[1:10], start = 6, stop = 9) <- "RQWW"

# add the artificial clonal expansion of two sequences to the sample dataset
clones <- data.frame(CDR3b = rep(x = "CATSRAAKPDGLAALETQYF", times = 3))
data_sample_e <- rbind(data_sample, clones)
clones <- data.frame(CDR3b = rep(x = "CATSRAAKPDGLAALSTQYF", times = 3))
data_sample_e <- rbind(data_sample_e, clones)

```

run clustirr

```{r run}
# ClustIRR version 2
clustirr_output_v2 <- cluster_irr(data_sample = data_sample,  
                                  data_ref = CD8,
                                  version = 2,
                                  ks = 4,
                                  cores = 1,
                                  control = list(
                                   B = 1000,
                                   global_max_dist = 1,
                                   local_max_fdr = 0.05,
                                   local_min_ove = 2,
                                   local_min_o = 3,
                                   trim_flank_aa = 3,
                                   low_mem = FALSE,
                                   global_pairs = NULL))

# ClustIRR version 3
clustirr_output_v3 <- cluster_irr(data_sample = data_sample,  
                                  data_ref = CD8,
                                  version = 3,
                                  ks = 4,
                                  cores = 1,
                                  control = list(
                                   B = 1000,
                                   global_max_dist = 1,
                                   local_max_fdr = 0.05,
                                   local_min_ove = 2,
                                   local_min_o = 3,
                                   trim_flank_aa = 3,
                                   low_mem = FALSE,
                                   global_pairs = NULL))

# ClustIRR version 2 exp
clustirr_output_v2_e <- cluster_irr(data_sample = data_sample_e,  
                                  data_ref = CD8,
                                  version = 2,
                                  ks = 4,
                                  cores = 1,
                                  control = list(
                                   B = 1000,
                                   global_max_dist = 1,
                                   local_max_fdr = 0.05,
                                   local_min_ove = 2,
                                   local_min_o = 3,
                                   trim_flank_aa = 3,
                                   low_mem = FALSE,
                                   global_pairs = NULL))

# ClustIRR version 3 exp
clustirr_output_v3_e <- cluster_irr(data_sample = data_sample_e,  
                                  data_ref = CD8,
                                  version = 3,
                                  ks = 4,
                                  cores = 1,
                                  control = list(
                                   B = 1000,
                                   global_max_dist = 1,
                                   local_max_fdr = 0.05,
                                   local_min_ove = 2,
                                   local_min_o = 3,
                                   trim_flank_aa = 3,
                                   low_mem = FALSE,
                                   global_pairs = NULL))

```

get_edges for all versions

```{r get_edges}
ge_v2 <- get_edges(clustirr_output_v2)
ge_v3 <- get_edges(clustirr_output_v3)

ge_v2_e <- get_edges(clustirr_output_v2_e)
ge_v3_e <- get_edges(clustirr_output_v3_e)

```

# Checking

```{r get_edge_check}
ge_v2
ge_v3
ge_v2_e
ge_v3_e

```

plot it with visNetwork

```{r plot_test_visN}
# v2
v2_edges <- data.frame(from = ge_v2$from_ID, to = ge_v2$to_ID)
ids <- ge_v2 %>% select(from_ID, to_ID) %>% t %>% c %>% unique

v2_nodes <- data.frame(id = ids)
v2_nodes$title <- v2_nodes$id

visNetwork(v2_nodes, v2_edges) %>% visPhysics(stabilization = TRUE)

# v3
v3_edges <- data.frame(from = ge_v3$from_ID, to = ge_v3$to_ID)
ids <- ge_v3 %>% select(from_ID, to_ID) %>% t %>% c %>% unique

v3_nodes <- data.frame(id = ids)
v3_nodes$title <- v3_nodes$id

visNetwork(v3_nodes, v3_edges) %>% visPhysics(stabilization = TRUE)

# v2_e
v2_e_edges <- data.frame(from = ge_v2_e$from_ID, to = ge_v2_e$to_ID)
ids <- ge_v2_e %>% select(from_ID, to_ID) %>% t %>% c %>% unique

v2_e_nodes <- data.frame(id = ids)
v2_e_nodes$title <- v2_e_nodes$id

visNetwork(v2_e_nodes, v2_e_edges) %>% visPhysics(stabilization = TRUE)

# v3_e
v3_e_edges <- data.frame(from = ge_v3_e$from_ID, to = ge_v3_e$to_ID)
ids <- ge_v3_e %>% select(from_ID, to_ID) %>% t %>% c %>% unique

v3_e_nodes <- data.frame(id = ids)
v3_e_nodes$title <- v3_e_nodes$id

visNetwork(v3_e_nodes, v3_e_edges) %>% visPhysics(stabilization = TRUE)
```

## Intermediate conclusion

Connecting clonal expanded sequences globally and in a unique way, i.e. one sequence as vertex receives multiple incoming edges, leads to doubled connections
